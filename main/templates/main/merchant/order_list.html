{% extends 'main/base.html' %}
{% block title %}商户订单管理 - 校园外卖{% endblock %}
{% block content %}
<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>我的订单</h2>
        <div>
            <!-- 订单状态筛选 -->
            <div class="btn-group">
                <a href="{% url 'merchant:merchant_order_list' %}" class="btn btn-sm {% if not request.GET.status %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    全部订单
                </a>
                <a href="{% url 'merchant:merchant_order_list' %}?status=0" class="btn btn-sm {% if request.GET.status == '0' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    待支付
                </a>
                <a href="{% url 'merchant:merchant_order_list' %}?status=1" class="btn btn-sm {% if request.GET.status == '1' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    已支付 ✅
                </a>
                <a href="{% url 'merchant:merchant_order_list' %}?status=2" class="btn btn-sm {% if request.GET.status == '2' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    已接单
                </a>
                <a href="{% url 'merchant:merchant_order_list' %}?status=3" class="btn btn-sm {% if request.GET.status == '3' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    已完成
                </a>
                <a href="{% url 'merchant:merchant_order_list' %}?status=4" class="btn btn-sm {% if request.GET.status == '4' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    已取消
                </a>
            </div>
        </div>
    </div>

    {% if not order_list %}
    <!-- 无订单时的提示 -->
    <div class="card text-center p-5 shadow-sm">
        <div class="bi bi-box text-muted fs-5 mb-3"></div>
        <h5 class="text-muted">暂无订单记录</h5>
        <p class="text-muted mt-2">等待用户下单吧～</p>
    </div>
    {% else %}
    <!-- 商家端订单列表 -->
    <div class="list-group gap-3">
        {% for order in order_list %}
        <div class="card shadow-sm">
            <!-- 订单头部信息 -->
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">用户：{{ order.user_name }}</span>
                    <span class="ms-3 {{ order.status_class }}">
                        {{ order.status_text }}
                    </span>
                </div>
                <div class="text-muted small">
                    订单号：{{ order.order.order_no }}
                </div>
            </div>

            <!-- 订单项列表 -->
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                        <thead>
                            <tr class="border-bottom">
                                <th>商品名称</th>
                                <th class="text-center">单价</th>
                                <th class="text-center">数量</th>
                                <th class="text-end">小计</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.order_items %}
                            <tr>
                                <td>{{ item.dish_name }}</td>
                                <td class="text-center">¥{{ item.price|floatformat:2 }}</td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">¥{{ item.subtotal|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 订单底部信息 + 操作按钮 -->
            <div class="card-footer d-flex justify-content-between align-items-center bg-white">
                <div>
                    <div>
                        <span class="text-muted">下单时间：</span>
                        <span>{{ order.order.create_time|date:'Y-m-d H:i:s' }}</span>
                    </div>
                    {% if order.order.pay_time %}
                    <div class="mt-1">
                        <span class="text-muted">支付时间：</span>
                        <span>{{ order.order.pay_time|date:'Y-m-d H:i:s' }}</span>
                    </div>
                    {% endif %}
                    <div class="mt-1">
                        <span class="text-muted">用户电话：</span>
                        <span>{{ order.user_phone }}</span>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold fs-5 text-danger">
                        总计：¥{{ order.order.total_price|floatformat:2 }}
                    </div>
                    <div class="mt-2">
                        <!-- 订单状态操作按钮 -->
                        {% if order.order.status == 1 %}
                        <!-- 已支付 → 接单 -->
                        <button class="btn btn-sm btn-primary handleOrderBtn" 
                                data-order-id="{{ order.order.id }}" 
                                data-target-status="2">
                            确认接单
                        </button>
                        {% elif order.order.status == 2 %}
                        <!-- 已接单 → 完成 -->
                        <button class="btn btn-sm btn-success handleOrderBtn" 
                                data-order-id="{{ order.order.id }}" 
                                data-target-status="3">
                            标记完成
                        </button>
                        {% elif order.order.status == 1 or order.order.status == 2 %}
                            <!-- 已支付/已接单 → 取消 -->
                            <button class="btn btn-sm btn-danger handleOrderBtn" 
                                    data-order-id="{{ order.order.id }}" 
                                    data-target-status="4">
                                取消订单
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- 订单状态操作JS -->
<script>
$(function() {
    // 绑定订单操作按钮（接单/完成/取消）
    $('.handleOrderBtn').click(function() {
        const orderId = $(this).data('order-id');
        const targetStatus = $(this).data('target-status');
        let actionText = '';
        
        // 判断操作类型
        if (targetStatus === 2) actionText = '接单';
        else if (targetStatus === 3) actionText = '标记为完成';
        else if (targetStatus === 4) actionText = '取消';
        else return;

        // 确认操作
        if (!confirm(`确定要${actionText}该订单吗？`)) {
            return;
        }

        // 调用商户订单更新API
        fetch("{% url 'merchant:merchant_order_update_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                order_id: orderId,
                status: targetStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.msg);
            // 操作成功刷新页面
            if (data.code === 1) {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('订单操作失败：', error);
            alert('网络错误，请稍后重试');
        });
    });
});
</script>
{% endblock %}