<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·é¦–é¡µ - æ ¡å›­å¤–å–å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .banner {
            height: 200px;
            background: linear-gradient(135deg, #0d6efd, #60a5fa);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }
        .category-card {
            text-align: center;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .category-icon {
            font-size: 40px;
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .hot-merchant {
            margin-bottom: 20px;
        }
        .merchant-card {
            transition: transform 0.3s;
        }
        .merchant-card:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    {% include 'main/common/nav.html' %}

    <!-- é¡¶éƒ¨Banner -->
    <div class="banner">
        <div class="text-center">
            <h1 class="display-4">æ ¡å›­ç¾é£Ÿï¼Œä¸€é”®é€è¾¾</h1>
            <p class="lead mt-2">é£Ÿå ‚ã€å¥¶èŒ¶ã€é›¶é£Ÿï¼Œæ»¡è¶³ä½ çš„å‘³è•¾éœ€æ±‚</p>
        </div>
    </div>

    <div class="container">
        <!-- åˆ†ç±»å¯¼èˆª -->
        <div class="row mb-5">
            <div class="col-md-3 category-card">
                <div class="category-icon">ğŸš</div>
                <h5>å¿«é¤ç®€é¤</h5>
                <p>ä¾¿æ·ç¾å‘³ï¼Œå¿«é€Ÿå°±é¤</p>
            </div>
            <div class="col-md-3 category-card">
                <div class="category-icon">ğŸ¥¤</div>
                <h5>å¥¶èŒ¶é¥®å“</h5>
                <p>æ¸…çˆ½è§£æ¸´ï¼Œç”œèœœæ—¶å…‰</p>
            </div>
            <div class="col-md-3 category-card">
                <div class="category-icon">ğŸŸ</div>
                <h5>é›¶é£Ÿå°åƒ</h5>
                <p>ä¼‘é—²æ—¶åˆ»ï¼Œè¡¥å……èƒ½é‡</p>
            </div>
            <div class="col-md-3 category-card">
                <div class="category-icon">ğŸ±</div>
                <h5>å¥åº·è½»é£Ÿ</h5>
                <p>ä½è„‚è¥å…»ï¼Œå¥åº·ç”Ÿæ´»</p>
            </div>
        </div>

        <!-- çƒ­é—¨å•†å®¶ -->
        <div class="hot-merchant">
            <h3 class="mb-3">çƒ­é—¨å•†å®¶</h3>
            <div class="row" id="hotMerchantList">
                <!-- åŠ¨æ€æ¸²æŸ“çƒ­é—¨å•†å®¶ -->
            </div>
        </div>

        <!-- æœ€è¿‘è®¢å•ï¼ˆå·²ç™»å½•æ˜¾ç¤ºï¼‰ -->
        {% if request.session.user_id %}
        <div class="recent-orders mt-5">
            <h3 class="mb-3">æˆ‘çš„æœ€è¿‘è®¢å•</h3>
            <div class="card" id="recentOrdersContainer">
                <!-- åŠ¨æ€æ¸²æŸ“æœ€è¿‘è®¢å• -->
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        $(function() {
            // åŠ è½½çƒ­é—¨å•†å®¶ï¼ˆå·²å®¡æ ¸é€šè¿‡+è¯„åˆ†â‰¥4.5ï¼‰
            loadHotMerchants();
            
            // å·²ç™»å½•ç”¨æˆ·åŠ è½½æœ€è¿‘è®¢å•
            {% if request.session.user_id %}
            loadRecentOrders();
            {% endif %}

            function loadHotMerchants() {
                fetch("{% url 'user:merchant_list_api' %}?hot=1", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        const merchants = data.data.filter(m => m.score >= 4.5);
                        let html = '';
                        merchants.slice(0, 6).forEach(merchant => {
                            // âœ… ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å®Œæ•´è·¯å¾„ï¼Œä¸æ‹¼æ¥ä»»ä½•å‰ç¼€
                            const logoUrl = merchant.logo || '/static/main/img/merchant/default_merchant.jpg';
                            html += `
                                <div class="col-md-4 hot-merchant">
                                    <div class="card merchant-card h-100">
                                        <img src="${logoUrl}" 
                                             class="card-img-top" alt="${merchant.name}" 
                                             style="height: 150px; object-fit: cover;">
                                        <div class="card-body">
                                            <h5 class="card-title">${merchant.name}</h5>
                                            <p class="card-text">åˆ†ç±»ï¼š${merchant.category}</p>
                                            <p class="card-text">è¯„åˆ†ï¼š${merchant.score} â˜…</p>
                                            <a href="{% url 'user:merchant_list' %}?merchant_id=` + merchant.id + `" class="btn btn-primary w-100">
                                                ç«‹å³ç‚¹é¤
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        $('#hotMerchantList').html(html);
                    } else {
                        $('#hotMerchantList').html('<div class="col-12 text-center text-danger">æš‚æ— çƒ­é—¨å•†å®¶</div>');
                    }
                });
            }

            // åŠ è½½æœ€è¿‘è®¢å•ï¼ˆä¿®æ­£ï¼šAPIè·¯å¾„æ”¹ä¸ºå‘½åç©ºé—´URL + æ–°å¢å–æ¶ˆè®¢å•æŒ‰é’®ï¼‰
            function loadRecentOrders() {
                fetch("{% url 'user:user_recent_orders_api' %}", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        const orders = data.data;
                        if (orders.length === 0) {
                            $('#recentOrdersContainer').html(`
                                <div class="card-body text-center">
                                    <p class="text-muted">æš‚æ— è®¢å•è®°å½•ï¼Œå¿«å»ä¸‹å•å§ï½</p>
                                    <!-- ä¿®æ­£ï¼šç»å¯¹è·¯å¾„æ”¹ä¸ºå‘½åç©ºé—´URL -->
                                    <a href="{% url 'user:merchant_list' %}" class="btn btn-primary">ç«‹å³ç‚¹é¤</a>
                                </div>
                            `);
                            return;
                        }

                        let html = '<div class="list-group list-group-flush">';
                        orders.slice(0, 3).forEach(order => { // æœ€å¤šæ˜¾ç¤º3ä¸ª
                            const statusText = ['å¾…æ”¯ä»˜', 'å·²æ”¯ä»˜', 'å·²æ¥å•', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'][order.status];
                            const statusClass = ['text-warning', 'text-primary', 'text-info', 'text-success', 'text-danger'][order.status];
                            
                            // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                            let cancelBtn = '';
                            if (order.status === 0 || order.status === 1) {
                                cancelBtn = `
                                    <button class="btn btn-sm btn-danger cancelOrderBtn ms-2" data-order-no="${order.order_no}">
                                        å–æ¶ˆè®¢å•
                                    </button>
                                `;
                            }
                            
                            html += `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">è®¢å•å·ï¼š${order.order_no}</h6>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <p class="mb-1">å•†å®¶ï¼š${order.merchant_name}</p>
                                    <p class="mb-1">æ—¶é—´ï¼š${order.create_time}</p>
                                    <p class="mb-0">é‡‘é¢ï¼šï¿¥${order.total_price.toFixed(2)}</p>
                                    <!-- ä¿®æ­£ï¼šç»å¯¹è·¯å¾„æ”¹ä¸ºå‘½åç©ºé—´URL -->
                                    <a href="{% url 'user:user_order_detail' %}?order_no=${order.order_no}" class="btn btn-sm btn-outline-primary mt-2">
                                        æŸ¥çœ‹è¯¦æƒ…
                                    </a>
                                    ${cancelBtn} <!-- æ’å…¥å–æ¶ˆè®¢å•æŒ‰é’® -->
                                </div>
                            `;
                        });
                        html += '</div>';
                        $('#recentOrdersContainer').html(html);
                        
                        // æ–°å¢ï¼šç»‘å®šé¦–é¡µå–æ¶ˆè®¢å•æŒ‰é’®äº‹ä»¶
                        $('.cancelOrderBtn').click(function() {
                            const orderNo = $(this).data('order-no');
                            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¯¥è®¢å•å—ï¼Ÿå–æ¶ˆåå°†æ— æ³•æ¢å¤ï¼')) {
                                return;
                            }

                            fetch("{% url 'user:cancel_order_api' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({order_no: orderNo})
                            })
                            .then(res => res.json())
                            .then(data => {
                                alert(data.msg);
                                // å–æ¶ˆæˆåŠŸé‡æ–°åŠ è½½æœ€è¿‘è®¢å•
                                if (data.code === 1) {
                                    loadRecentOrders();
                                }
                            })
                            .catch(error => {
                                console.error('å–æ¶ˆè®¢å•å¤±è´¥ï¼š', error);
                                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                            });
                        });
                    } else {
                        $('#recentOrdersContainer').html(`
                            <div class="card-body text-center text-danger">${data.msg}</div>
                        `);
                    }
                });
            }
        });
    </script>
</body>
</html>