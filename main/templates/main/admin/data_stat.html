<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计 - 校园外卖管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入ECharts图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .stat-card { border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
        .stat-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .stat-item { text-align: center; padding: 15px; }
        .stat-value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #666; }
        .chart-container { width: 100%; height: 400px; margin-top: 20px; }
    </style>
</head>
<body>
    {% include 'main/common/nav.html' %}

    <div class="container mt-4">
        <h3 class="mb-4">平台数据统计</h3>

        <!-- 核心数据概览 -->
        <div class="stat-card">
            <div class="stat-header">
                <h5>核心数据概览</h5>
            </div>
            <div class="row">
                <div class="col-md-3 stat-item">
                    <div class="stat-value text-primary" id="totalUser">0</div>
                    <div class="stat-label">总用户数</div>
                </div>
                <div class="col-md-3 stat-item">
                    <div class="stat-value text-success" id="totalMerchant">0</div>
                    <div class="stat-label">已通过商家数</div>
                </div>
                <div class="col-md-3 stat-item">
                    <div class="stat-value text-info" id="totalOrder">0</div>
                    <div class="stat-label">总订单数</div>
                </div>
                <div class="col-md-3 stat-item">
                    <div class="stat-value text-danger" id="totalSales">0.00</div>
                    <div class="stat-label">总销售额（元）</div>
                </div>
            </div>
        </div>

        <!-- 订单趋势图表 -->
        <div class="stat-card">
            <div class="stat-header">
                <h5>近7日订单趋势</h5>
            </div>
            <div class="chart-container" id="orderTrendChart"></div>
        </div>

        <!-- 商家销售额排行 -->
        <div class="stat-card">
            <div class="stat-header">
                <h5>商家销售额排行（Top10）</h5>
            </div>
            <div class="chart-container" id="merchantSalesChart"></div>
        </div>

        <!-- 分类订单占比 -->
        <div class="stat-card">
            <div class="stat-header">
                <h5>店铺分类订单占比</h5>
            </div>
            <div class="chart-container" id="categoryOrderChart"></div>
        </div>
    </div>

    <script>
        $(function() {
            // 加载核心数据
            loadCoreStats();
            // 初始化图表
            initOrderTrendChart();
            initMerchantSalesChart();
            initCategoryOrderChart();

            // ---------------------- 核心数据加载 ----------------------
            function loadCoreStats() {
                fetch("/admin/data/core/api/", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        const stats = data.data;
                        $('#totalUser').text(stats.total_user);
                        $('#totalMerchant').text(stats.total_merchant);
                        $('#totalOrder').text(stats.total_order);
                        $('#totalSales').text(stats.total_sales.toFixed(2));
                    }
                });
            }

            // ---------------------- 订单趋势图表 ----------------------
            function initOrderTrendChart() {
                const chartDom = document.getElementById('orderTrendChart');
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['订单数', '销售额（元）'] },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: [] },
                    yAxis: [{ type: 'value', name: '订单数' }, { type: 'value', name: '销售额' }],
                    series: [
                        {
                            name: '订单数',
                            type: 'line',
                            yAxisIndex: 0,
                            data: [],
                            itemStyle: { color: '#0d6efd' }
                        },
                        {
                            name: '销售额（元）',
                            type: 'bar',
                            yAxisIndex: 1,
                            data: [],
                            itemStyle: { color: '#198754' }
                        }
                    ]
                };

                // 加载近7日订单趋势数据
                fetch("/admin/data/order/trend/api/", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        option.xAxis.data = data.data.dates;
                        option.series[0].data = data.data.order_counts;
                        option.series[1].data = data.data.sales_amounts;
                        myChart.setOption(option);
                    }
                });

                // 窗口大小变化时自适应
                window.addEventListener('resize', () => myChart.resize());
            }

            // ---------------------- 商家销售额排行图表 ----------------------
            function initMerchantSalesChart() {
                const chartDom = document.getElementById('merchantSalesChart');
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'value', name: '销售额（元）' },
                    yAxis: { type: 'category', data: [] },
                    series: [{
                        name: '销售额',
                        type: 'bar',
                        data: [],
                        itemStyle: { color: '#0dcaf0' }
                    }]
                };

                // 加载商家销售额排行数据
                fetch("/admin/data/merchant/sales/api/", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        option.yAxis.data = data.data.merchant_names;
                        option.series[0].data = data.data.sales_amounts;
                        myChart.setOption(option);
                    }
                });

                window.addEventListener('resize', () => myChart.resize());
            }

            // ---------------------- 分类订单占比图表 ----------------------
            function initCategoryOrderChart() {
                const chartDom = document.getElementById('categoryOrderChart');
                const myChart = echarts.init(chartDom);
                const option = {
                    tooltip: { trigger: 'item' },
                    legend: { top: '5%', left: 'center' },
                    series: [{
                        name: '订单占比',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: { show: false, position: 'center' },
                        emphasis: {
                            label: { show: true, fontSize: 16, fontWeight: 'bold' }
                        },
                        labelLine: { show: false },
                        data: []
                    }]
                };

                // 加载分类订单占比数据
                fetch("/admin/data/category/order/api/", {
                    method: 'GET',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 1) {
                        option.series[0].data = data.data;
                        myChart.setOption(option);
                    }
                });

                window.addEventListener('resize', () => myChart.resize());
            }
        });
    </script>
</body>
</html>